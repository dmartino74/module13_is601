test:
  runs-on: ubuntu-latest
  services:
    postgres:
      image: postgres:18
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: fastapi_db
      ports:
        - 5432:5432
      options: >-
        --health-cmd pg_isready
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install apt deps required by Playwright
      run: |
        sudo apt-get update
        sudo apt-get install -y libnss3 libatk1.0-0 libatk-bridge2.0-0 libxss1 libpangocairo-1.0-0 libasound2

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Prepare python venv and install dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        python -m pip install pytest-playwright
        python -m playwright install --with-deps

    - name: Prepare test results folder
      run: mkdir -p test-results

    - name: Run unit and integration tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fastapi_db
        PYTHONPATH: ${{ github.workspace }}
        PORT: 8000
      run: |
        source .venv/bin/activate
        pytest tests/unit/ --cov=app --junitxml=test-results/unit.xml -q
        pytest tests/integration/ --junitxml=test-results/integration.xml -q

    - name: Run E2E tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fastapi_db
        PYTHONPATH: ${{ github.workspace }}
        PORT: 8000
      run: |
        source .venv/bin/activate
        # run E2E tests separately so failures are obviously E2E-related
        pytest tests/e2e/ --junitxml=test-results/e2e.xml -q

          